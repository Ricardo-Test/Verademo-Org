parameters:
  vulnerabilities_as_json: ''
  issue_type: ''
  project_name: ''
  organization: ''
  
steps:
- task: CmdLine@2
  env:
    API_CREDENTIALS: $(AZURE_API_CREDENTIALS)
  inputs:
    script: |      
      ApiUrl="https://dev.azure.com/${{ parameters.organization }}/${{ parameters.project_name }}/_apis/wit/workitems/$${{ parameters.issue_type }}?api-version=6.0"
      AUTH=$(echo -ne "anything:$API_CREDENTIALS" | base64 --wrap 0)
      
      sca_json='${{ parameters.vulnerabilities_as_json }}'
      for encodedVulnerability in $(echo "${sca_json}" | jq -r '.[] | @base64'); do
        vulnerabilityAsJson=$(echo "$encodedVulnerability" | base64 --decode)
        
        title=$( jq -r  '.title' <<< "${vulnerabilityAsJson}" ) 
        overview=$( jq -r  '.overview' <<< "${vulnerabilityAsJson}" ) 
        cve=$( jq -c  '.cve' <<< "${vulnerabilityAsJson}" ) 
        link=$( jq -c  '._links.html' <<< "${vulnerabilityAsJson}" ) 
        
        ticketTitle="Veracode SCA - $title"
        description="<ul><li>Overview: $overview</li><li>CVE: $cve</li><li><a href=$link>Veracode Database Link</a></li></ul>"       
                        
        Body="[{
          "op": "add",
          "path": "/fields/System.Title",
          "from": null,
          "value": "$ticketTitle"
        },
        {
          "op": "add",
          "path": "/fields/System.Description",
          "from": null,
          "value": "$description"
        }]"
        command='curl --header "Content-Type: application/json-patch+json" --header "Authorization: Basic $AUTH" --request POST --data $Body $ApiUrl'
        echo $command
        `$command`
        echo "Ticket created with:\nTitle: $title\nDescription: $description"
        echo --------------------------
        echo ""
      done
