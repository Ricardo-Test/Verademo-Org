parameters:
  vulnerabilities_as_json: ''
  issue_type: ''
  organization: ''
  project_name: ''
  
steps:
- task: CmdLine@2
  name: CreateTickets
  env:
    API_CREDENTIALS: $(AZURE_API_CREDENTIALS)
  inputs:
    script: |      
      ApiUrl="https://dev.azure.com/${{ parameters.organization }}/${{ parameters.project_name }}/_apis/wit/workitems/"'$'"${{ parameters.issue_type }}?api-version=6.0"
      Authentication="anything:$API_CREDENTIALS"
      
      sca_json='${{ parameters.vulnerabilities_as_json }}'
      for encodedVulnerability in $(echo "${sca_json}" | jq -r '.[] | @base64'); do
        vulnerabilityAsJson=$(echo "$encodedVulnerability" | base64 --decode)
        
        title=$( jq -r  '.title' <<< "${vulnerabilityAsJson}" ) 
        overview=$( jq -r  '.overview' <<< "${vulnerabilityAsJson}" ) 
        cve=$( jq -c  '.cve' <<< "${vulnerabilityAsJson}" )         
        
        if [[ $cve == "null" ]]; then 
          cveContent="none"
        else
          cveWithoutQuotes=$( tr -d '"' <<< $cve ) 
          cveLink="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-$cveWithoutQuotes"
          cveLink='\"'"$cveLink"'\"'
          cveContent="<a href=$cveLink>$cveWithoutQuotes</a>"
        fi
        
        vulnerabilityTypes=$( jq -c '.vulnerabilityTypes[]' <<< "${vulnerabilityAsJson}" )
        vulnerabilityTypes=$( tr -d '"' <<< $vulnerabilityTypes ) 
        if [[ $vulnerabilityTypes == "" ]]; then 
          vulnerabilityTypesAsString=""
        else
          for vulnerabilityType in $vulnerabilityTypes; do
            vulnerabilityTypesAsString="$vulnerabilityTypesAsString, $vulnerabilityType"
          done
          vulnerabilityTypesAsString=${vulnerabilityTypesAsString:2}   
        fi
        
        
        
        cveWithoutQuotes=$( tr -d '"' <<< "$cve")
        versionRange=$( jq -c  '.libraries[0].details[0].versionRange' <<< "${vulnerabilityAsJson}" )
        versionRange=$( tr -d '"' <<< $versionRange )
        updateToVersion=$( jq -c  '.libraries[0].details[0].updateToVersion' <<< "${vulnerabilityAsJson}" )
        updateToVersion=$( tr -d '"' <<< $updateToVersion )
        
        if [[ $updateToVersion == "" ]]; then 
          updateToVersion="none"
        fi
        if [[ $updateToVersion == "null" ]]; then 
          updateToVersion="none"
        fi
        
        link=$( jq -c  '._links.html' <<< "${vulnerabilityAsJson}" )
        vulnerabilityLink=$( tr -d '"' <<< $link )
        vulnerabilityLink='\"'"$vulnerabilityLink"'\"'
        
        cvssScore=$( jq -c '.cvssScore' <<< "${vulnerabilityAsJson}" )
        
        ticketTitle="Veracode SCA - $title"     
        description=$( tr '"' '\"' <<< "<ul><li>Overview: $overview</li><li>Vulnerability Types: $vulnerabilityTypesAsString</li><li>Version Range: $versionRange</li><li>Recommended Version: $updateToVersion</li><li>CVSS Score: $cvssScore</li><li>CVE: $cveContent</li><li><a href=$vulnerabilityLink>Veracode Database Link</a></li></ul>" )
        echo $description
                        
        Body='[{
          "op": "add",
          "path": "/fields/System.Title",
          "value": "'"$ticketTitle"'"
        },
        {
          "op": "add",
          "path": "/fields/System.Description",
          "value": "'"$description"'"
        }]'

        curl -X POST -H 'Content-Type: application/json-patch+json' -u "$Authentication" -d "$Body" $ApiUrl
        
        echo Ticket created.
        echo Title: $title
        echo Description: $description
        echo --------------------------
        echo ""
      done
